<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tests menu chats</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg-gradient: radial-gradient(circle at 20% 20%, rgba(79, 70, 229, 0.12), transparent 25%),
                             radial-gradient(circle at 80% 0%, rgba(236, 72, 153, 0.12), transparent 25%),
                             linear-gradient(135deg, #f6f8fb 0%, #eef2ff 50%, #fdf2f8 100%);
            --card-bg: rgba(255, 255, 255, 0.8);
            --shadow: 0 20px 50px rgba(0, 0, 0, 0.08);
            --border: 1px solid rgba(255, 255, 255, 0.5);
            --text: #1f2937;
            --accent: #6366f1;
            --accent-2: #ec4899;
            --muted: #6b7280;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-image: var(--bg-gradient);
            min-height: 100vh;
            padding: 32px 16px 48px;
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .page {
            width: min(1100px, 100%);
            position: relative;
        }
        .glow {
            position: absolute;
            inset: 0;
            filter: blur(60px);
            opacity: 0.4;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.25), transparent 45%),
                        radial-gradient(circle at 80% 30%, rgba(236, 72, 153, 0.25), transparent 35%);
            z-index: 0;
            animation: float 14s ease-in-out infinite alternate;
        }
        @keyframes float {
            from { transform: translateY(0px); }
            to { transform: translateY(-18px); }
        }
        header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        h1 {
            color: #0f172a;
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
        }
        .subtitle {
            color: var(--muted);
            font-size: 16px;
            margin-bottom: 16px;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(99, 102, 241, 0.1);
            color: #4338ca;
            border-radius: 999px;
            font-weight: 600;
            font-size: 13px;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        #chat-container {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: var(--border);
            backdrop-filter: blur(14px);
            overflow: hidden;
            display: grid;
            grid-template-rows: 1fr auto;
            min-height: 70vh;
            position: relative;
            z-index: 1;
        }
        #chat {
            padding: 22px 22px 12px;
            overflow-y: auto;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.85), rgba(248, 250, 252, 0.92));
        }
        .message {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 18px;
            animation: fade-in 0.4s ease;
        }
        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }
        .avatar {
            width: 34px;
            height: 34px;
            border-radius: 12px;
            display: grid;
            place-items: center;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.25);
        }
        .message.ai .avatar { background: linear-gradient(135deg, #0ea5e9, #6366f1); }
        .username { font-weight: 700; color: #0f172a; }
        .bubble {
            padding: 14px 16px;
            border-radius: 16px;
            position: relative;
            line-height: 1.6;
            border: 1px solid rgba(15, 23, 42, 0.05);
        }
        .message.user .bubble {
            background: white;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        }
        .message.ai .bubble {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.12), rgba(99, 102, 241, 0.12));
            border-color: rgba(99, 102, 241, 0.18);
        }
        .text { color: #0f172a; }
        .typing { color: var(--muted); font-style: italic; }
        #input-area {
            padding: 18px 20px;
            background: rgba(255, 255, 255, 0.9);
            border-top: 1px solid rgba(226, 232, 240, 0.8);
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            align-items: center;
        }
        .inputs {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 10px;
        }
        #username, #message {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: rgba(255, 255, 255, 0.95);
        }
        #username:focus, #message:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
            outline: none;
        }
        button {
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: white;
            border: none;
            padding: 12px 22px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            box-shadow: 0 12px 30px rgba(236, 72, 153, 0.25);
        }
        button:hover { transform: translateY(-1px); box-shadow: 0 14px 34px rgba(99, 102, 241, 0.25); }
        button:active { transform: translateY(0); }
        button:disabled {
            background: #cbd5e1;
            box-shadow: none;
            cursor: not-allowed;
        }
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--muted);
            margin-top: 4px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.15);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.2); }
            70% { box-shadow: 0 0 0 12px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media (max-width: 720px) {
            #chat-container { min-height: 70vh; }
            .inputs { grid-template-columns: 1fr; }
            #input-area { grid-template-columns: 1fr; }
            button { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="glow" aria-hidden="true"></div>
        <header>
            <div class="badge">üí¨ AI —á–∞—Ç</div>
            <h1>Tests menu chats</h1>
            <p class="subtitle">–õ—ë–≥–∫–∏–π –∏ –¥–∏–Ω–∞–º–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤ —Å AI</p>
        </header>

        <div id="chat-container">
            <div id="chat">
                <div class="message user">
                    <div class="message-header">
                        <div class="avatar">–ü</div>
                        <div class="username">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                    </div>
                </div>
            </div>
            <div id="input-area">
                <div class="inputs">
                    <input type="text" id="username" placeholder="–í–∞—à–µ –∏–º—è" value="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" maxlength="30">
                    <input type="text" id="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500">
                </div>
                <div>
                    <button onclick="sendMessage()" id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    <div class="status">
                        <span class="status-dot"></span>
                        <span>–û–Ω–ª–∞–π–Ω ‚Ä¢ AI –≥–æ—Ç–æ–≤ –∫ –¥–∏–∞–ª–æ–≥—É</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        const chatBox = document.getElementById('chat');
        const messageInput = document.getElementById('message');
        const usernameInput = document.getElementById('username');
        const sendBtn = document.getElementById('send-btn');

        function createAvatarLetter(name) {
            return escapeHtml(name.trim().charAt(0).toUpperCase() || '–ê');
        }

        function appendMessage(user, text, options = {}) {
            const { role = 'user', isTyping = false } = options;
            const message = document.createElement('div');
            message.className = `message ${role}`;

            const header = document.createElement('div');
            header.className = 'message-header';

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.innerHTML = createAvatarLetter(user);

            const nameEl = document.createElement('div');
            nameEl.className = 'username';
            nameEl.textContent = user;

            header.appendChild(avatar);
            header.appendChild(nameEl);
            message.appendChild(header);

            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            const textSpan = document.createElement('span');
            textSpan.className = isTyping ? 'typing' : 'text';
            textSpan.textContent = text;
            bubble.appendChild(textSpan);
            message.appendChild(bubble);

            chatBox.appendChild(message);
            chatBox.scrollTop = chatBox.scrollHeight;
            return textSpan;
        }

        function typeText(element, fullText, delay = 22) {
            return new Promise(resolve => {
                let i = 0;
                const timer = setInterval(() => {
                    if (i < fullText.length) {
                        element.textContent = fullText.substring(0, i + 1);
                        i++;
                        chatBox.scrollTop = chatBox.scrollHeight;
                    } else {
                        clearInterval(timer);
                        resolve();
                    }
                }, delay);
            });
        }

        async function loadInitialMessages() {
            try {
                const res = await fetch('/api/messages');
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                const messages = await res.json();
                chatBox.innerHTML = '';
                if (messages.length === 0) {
                    const messages_aasaad = 1
                } else {
                    messages.forEach(msg => {
                        const role = msg.username && msg.username.toLowerCase() === 'ai' ? 'ai' : 'user';
                        appendMessage(msg.username, msg.text, { role });
                    });
                }
            } catch (err) {
                console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é:', err);
                chatBox.innerHTML = '<div class="message" style="color:red">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>';
            }
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            const user = (usernameInput.value || '–ê–Ω–æ–Ω–∏–º').trim();

            if (!text) {
                messageInput.focus();
                return;
            }

            appendMessage(user, text, { role: 'user' });
            messageInput.value = '';
            sendBtn.disabled = true;

            const typingText = appendMessage('AI', '–ø–µ—á–∞—Ç–∞–µ—Ç...', { role: 'ai', isTyping: true });

            try {
                const res = await fetch('/api/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, text: text })
                });

                if (!res.ok) throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É');

                const data = await res.json();

                typingText.closest('.message')?.remove();

                const aiTextSpan = appendMessage(data.ai_message.username, '', { role: 'ai' });
                await typeText(aiTextSpan, data.ai_message.text);

            } catch (err) {
                console.error('–û—à–∏–±–∫–∞:', err);
                typingText.closest('.message')?.remove();
                appendMessage('–°–∏—Å—Ç–µ–º–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', { role: 'ai' });
            } finally {
                sendBtn.disabled = false;
                messageInput.focus();
            }
        }

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        loadInitialMessages();
    </script>
</body>
